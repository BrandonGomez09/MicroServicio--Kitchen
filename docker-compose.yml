services:
  # --- 1. Servicio de Base de Datos (PostgreSQL) ---
  # Idéntico a tu configuración anterior 
  postgres-db:
    image: postgres:15-alpine
    container_name: kitchens_db
    hostname: postgres-db # Nombre clave para la conexión
    restart: always
    environment:
      # Lee las variables desde tu archivo .env
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432" # Expone el puerto de la BD a tu PC
    volumes:
      - ./postgres-data:/var/lib/postgresql/data

  # --- 2. Servicio de la API (Nuestra App de Node.js) ---
  api-service:
    build: . # Construye la imagen usando el Dockerfile de esta carpeta
    container_name: api-service
    restart: always
    expose:
      - "3000" # El puerto interno de la app (el de .env)
    depends_on:
      - postgres-db # No inicies hasta que la BD esté lista
    environment:
      # Pasa TODAS las variables de .env al contenedor
      PORT: ${PORT}
      DB_HOST: postgres-db # <-- CAMBIO CRÍTICO
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}

  # --- 3. Servicio de Nginx (La Puerta de Entrada) ---
  # Similar a tu configuración anterior [cite: 180]
  nginx:
    image: nginx:alpine
    container_name: reverse-proxy
    ports:
      - "80:80" # El único puerto expuesto a tu laptop
    volumes:
      # Montamos nuestra configuración de Nginx
      - ./nginx/app.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - api-service # Depende de nuestra API